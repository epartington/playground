---
- name: KVM Bootstrap
  hosts: localhost

  vars:
    #ansible_python_interpreter: /Users/jholland/opt/miniconda3/bin/python3

    # FQDN/hostname for the firewall
    hostname: "fw01"
    # IPv6 address
    ipv6_address: "2001:0db8:85a3:0000:0000:8a2e:0370:7334"
    # IPv6 gateway
    ipv6_gateway: "2001:0db8:85a3:0000:ffff:ffff:ffff:ffff"
    # IPv6 subnet
    ipv6_subnet: "/64"
    # DNS server
    dns_server01: "2044:0db8:85a3:0000:ffff:ffff:ffff:ffff"
    dns_server02: "2045:0db8:85a3:0000:ffff:ffff:ffff:ffff"
    # Group name for configuration membership
    device_group: "train-dg"
    template_stack: "train-ts"
    # URL for configuration management
    panorama01: "2004:0db8:85a3:0000:0000:8a2e:0370:7334"
    panorama02: "2004:0db8:85a3:0000:0000:8a2e:0370:7335"
    # EXTRA - Auth for Panorama
    vmauthkey: "ABCDEFGHIJKL"

    # Directories for bootstrap ISO
    directories:
      - name: "config"
      - name: "software"
      - name: "license"
      - name: "contents"
      - name: "plugins"

  tasks:
    - name: Create directories
      ansible.builtin.file:
        path: "bootstrap/{{ item.name }}"
        state: directory
      with_items: "{{ directories }}"

    - name: Create init-cfg.txt
      copy:
        dest: "bootstrap/config/init-cfg.txt"
        content: |
          type=dhcp
          hostname={{ hostname }}
          ipv6-address={{ ipv6_address }}{{ ipv6_subnet }}
          ipv6-default-gateway={{ ipv6_gateway }}
          panorama-server={{ panorama01 }}
          panorama-server-2={{ panorama02 }}
          dgname={{ device_group }}
          tplname={{ template_stack }}
          dns-primary={{ dns_server01 }}
          dns-secondary={{ dns_server02 }}
          vm-auth-key={{ vmauthkey }}

    # Reqs: mkisofs (Linux) or cdrtools (macOS)
    - name: Create bootstrap ISO
      shell: "mkisofs -o bootstrap.iso -iso-level 4 bootstrap"

    # # Reqs: pycdlib via pip
    # - name: Create bootstrap ISO
    #   community.general.iso_create:
    #     src_files:
    #       - bootstrap/config/init-cfg.txt
    #       - bootstrap/software
    #       - bootstrap/license
    #       - bootstrap/contents
    #       - bootstrap/plugins
    #     dest_iso: bootstrap.iso
    #     vol_ident: "BOOTSTRAP"
    #     interchange_level: 4
    #     joliet: 3
    #     rock_ridge: 1.09

    - name: Download VM-Series base image
      get_url:
        url: https://jholland.jfrog.io/artifactory/default-generic-local/PA-VM-KVM-10.1.3.qcow2
        checksum: sha256:70a6ee390fa721a8565a0b2e3f67826b6d5f064677ebfb4fbcde70454a697a52
        dest: ./PA-VM-KVM-10.1.3.qcow2

