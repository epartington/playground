---
- name: KVM Bootstrap
  hosts:
    all

    # Reqs:
    # "ansible-galaxy collection install community.libvirt"
    # mkisofs (Linux) or cdrtools (macOS)

  vars:
    #ansible_python_interpreter: /Users/jholland/opt/miniconda3/bin/python3

    # GIVEN VARIABLES
    # FQDN/hostname for the firewall
    hostname: "fw01"
    # IPv6 address
    #ipv6_address: "fd85:e493:71ca::5"
    ipv6_address: "2600:1900:40c0:a4f1:0:5::"
    # IPv6 gateway
    #ipv6_gateway: "fd85:e493:71ca::1"
    ipv6_gateway: "fe80::4001:aff:fe00:401"
    # IPv6 subnet
    ipv6_subnet: "/128"
    # DNS server
    #dns_server01: "2620:119:35::35"
    #dns_server02: "2620:119:53::53"
    dns_server01: "1.1.1.1"
    dns_server02: "4.2.2.2"
    # Group name for configuration membership
    device_group: "train-dg"
    template_stack: "train-ts"
    # URL for configuration management
    panorama01: "" # variable set in vars.yml
    panorama02: "" # variable set in vars.yml

    # EXTRA VARIABLES
    # Auth for Panorama
    vmauthkey: "" # variable set in vars.yml
    plugin_authkey: "" # variable set in vars.yml
    # PAN-OS Version
    panos_version: "10.1.4"
    # Non-utilised "dummy" IPv4 addressing
    ipv4_address: "192.168.122.250"
    ipv4_mask: "255.255.255.0"
    ipv4_gateway: "192.168.122.1"
    # Disk location of VM-Series base image
    image_download_dir: "/home/jholland/vm-images"
    image_download_location: "/home/jholland/vm-images/PA-VM-KVM-{{ panos_version }}.qcow2"
    image_runtime_location: "/home/jholland/PA-VM-KVM-{{ panos_version }}.qcow2"
    # Disk location of bootstrap ISO for VM-Series
    iso_location: "/home/jholland/bootstrap{{ hostname }}.iso"
    # Getting the base image
    image_url: "" # variable set in vars.yml
    image_hash: "" # variable set in vars.yml

    # Directories for bootstrap ISO
    directories:
      - name: "config"
      - name: "software"
      - name: "license"
      - name: "content"
      - name: "plugins"

  tasks:
    - name: Create directories
      ansible.builtin.file:
        path: "bootstrap/{{ item.name }}"
        state: directory
      with_items: "{{ directories }}"

    - name: Create init-cfg.txt
      copy:
        dest: "bootstrap/config/init-cfg.txt"
        content: |
          type=dhcp-client
          hostname={{ hostname }}
          panorama-server={{ panorama01 }}
          panorama-server-2={{ panorama02 }}
          dgname={{ device_group }}
          tplname={{ template_stack }}
          dns-primary={{ dns_server01 }}
          dns-secondary={{ dns_server02 }}
          auth-key={{ plugin_authkey }}
          plugin-op-commands=panorama-licensing-mode-on
    #          vm-auth-key={{ vmauthkey }}
    #          ip-address={{ ipv4_address }}
    #          netmask={{ ipv4_mask }}
    #          default-gateway={{ ipv4_gateway  }}
    #          ipv6-address={{ ipv6_address }}{{ ipv6_subnet }}
    #          ipv6-default-gateway={{ ipv6_gateway }}

    - name: Create bootstrap ISO
      shell: "mkisofs -o {{ iso_location }} -iso-level 4 bootstrap"

    - name: Create image directory
      ansible.builtin.file:
        path: "{{ image_download_dir }}"
        state: directory

    - name: Download VM-Series base image
      ansible.builtin.get_url:
        url: "{{ image_url }}"
        checksum: "{{ image_hash }}"
        dest: "{{ image_download_location }}"

    - name: Copy base image to runtime location
      ansible.builtin.copy:
        src: "{{ image_download_location }}"
        dest: "{{ image_runtime_location }}"
        remote_src: yes

    - name: Get VMs list
      community.libvirt.virt:
        command: list_vms
      register: empty_vms
      changed_when: no
      become: yes

    - name: Display VMs
      debug:
        msg:
          - "{{ empty_vms }}"

    - name: Create VM if not exists
      block:
        - name: Create VM-Series VM
          community.libvirt.virt:
            command: define
            xml: "{{ lookup('template', 'pa-vm-paramd.xml.j2') }}"
          become: yes
      when: "hostname not in empty_vms.list_vms"

    - name: Get VMs list again again
      community.libvirt.virt:
        command: list_vms
      register: now_vms
      changed_when: no
      become: yes

    - name: Display VMs
      debug:
        msg:
          - "{{ now_vms }}"

    - name: Start VM
      community.libvirt.virt:
        name: "{{ hostname }}"
        state: running
      register: vm_start_results
      until: "vm_start_results is success"
      retries: 15
      delay: 2
      become: yes
