resource "panos_panorama_ike_crypto_profile" "ike-profile" {
    template = var.panorama_template
    name = "ike-profile"
    dh_groups = ["group2"]
    authentications = ["sha1"]
    encryptions = ["aes-128-cbc"]
    lifetime_type = "seconds"
    lifetime_value = 28800
}

resource "panos_panorama_ipsec_crypto_profile" "ipsec-profile" {
    template = var.panorama_template
    name = "ipsec-profile"
    authentications = ["sha1"]
    encryptions = ["aes-128-cbc"]
    dh_group = "group2"
    lifetime_type = "seconds"
    lifetime_value = 28800
}

resource "panos_panorama_ike_gateway" "ike-gw1" {
    template = var.panorama_template
    name = "ike-gw1"
    peer_ip_type = "ip"
    interface = "ethernet1/1"
    local_ip_address_type = ""
    pre_shared_key = var.ike_psk1
    peer_ip_value = var.awspeer1
    ikev1_crypto_profile = "ike-profile"
    enable_dead_peer_detection = true
    dead_peer_detection_interval = 10
    dead_peer_detection_retry = 3
}

resource "panos_panorama_ike_gateway" "ike-gw2" {
    template = var.panorama_template
    name = "ike-gw2"
    peer_ip_type = "ip"
    interface = "ethernet1/1"
    local_ip_address_type = ""
    pre_shared_key = var.ike_psk2
    peer_ip_value = var.awspeer2
    ikev1_crypto_profile = "ike-profile"
    enable_dead_peer_detection = true
    dead_peer_detection_interval = 10
    dead_peer_detection_retry = 3
}

resource "panos_panorama_zone" "vpn" {
    template = var.panorama_template
    name = "vpn"
    mode = "layer3"
    interfaces = [
        panos_panorama_tunnel_interface.tunnel-10.name,
        panos_panorama_tunnel_interface.tunnel-11.name
    ]
}

resource "panos_panorama_tunnel_interface" "tunnel-10" {
    template = var.panorama_template
    name = "tunnel.10"
    static_ips = ["169.254.175.130/30"]
}

resource "panos_panorama_tunnel_interface" "tunnel-11" {
    template = var.panorama_template
    name = "tunnel.11"
    static_ips = ["169.254.138.110/30"]
}

resource "panos_panorama_virtual_router_entry" "add-tun-10" {
    template = var.panorama_template
    virtual_router = "default"
    interface = panos_panorama_tunnel_interface.tunnel-10.name
}

resource "panos_panorama_virtual_router_entry" "add-tun-11" {
    template = var.panorama_template
    virtual_router = "default"
    interface = panos_panorama_tunnel_interface.tunnel-11.name
}

resource "panos_panorama_ipsec_tunnel" "ipsec-tunnel-1" {
    template = var.panorama_template
    name = "ipsec-tunnel-1"
    tunnel_interface = panos_panorama_tunnel_interface.tunnel-10.name
    anti_replay = true
    ak_ike_gateway = "ike-gw1"
    ak_ipsec_crypto_profile = "ipsec-profile"
    enable_tunnel_monitor = true
    tunnel_monitor_destination_ip = "169.254.175.129"
}

resource "panos_panorama_ipsec_tunnel" "ipsec-tunnel-2" {
    template = var.panorama_template
    name = "ipsec-tunnel-2"
    tunnel_interface = panos_panorama_tunnel_interface.tunnel-11.name
    anti_replay = true
    ak_ike_gateway = "ike-gw2"
    ak_ipsec_crypto_profile = "ipsec-profile"
    enable_tunnel_monitor = true
    tunnel_monitor_destination_ip = "169.254.138.109"
}

resource "panos_panorama_bgp" "bgp" {
    template = var.panorama_template
    virtual_router = "default"
    router_id = "10.0.0.10"
    as_number = "65000"
    install_route = true
}

resource "panos_panorama_bgp_peer_group" "bgp_peer_group" {
    template = var.panorama_template
    virtual_router = "default"
    name = "bgp_peer_group"
    depends_on = [
      panos_panorama_bgp.bgp
    ]
}

resource "panos_panorama_bgp_peer" "bgp_peer1" {
    template = var.panorama_template
    virtual_router = "default"
    bgp_peer_group = panos_panorama_bgp_peer_group.bgp_peer_group.name
    name = "bgp_peer1"
    peer_as = "64512"
    local_address_interface = panos_panorama_tunnel_interface.tunnel-10.name
    local_address_ip = panos_panorama_tunnel_interface.tunnel-10.static_ips.0
    peer_address_ip = "169.254.175.129"
    max_prefixes = 5000
}

resource "panos_panorama_bgp_peer" "bgp_peer2" {
    template = var.panorama_template
    virtual_router = "default"
    bgp_peer_group = panos_panorama_bgp_peer_group.bgp_peer_group.name
    name = "bgp_peer2"
    peer_as = "64512"
    local_address_interface = panos_panorama_tunnel_interface.tunnel-11.name
    local_address_ip = panos_panorama_tunnel_interface.tunnel-11.static_ips.0
    peer_address_ip = "169.254.138.109"
    max_prefixes = 5000
}

resource "panos_panorama_redistribution_profile_ipv4" "redist_profile" {
    template = var.panorama_template
    virtual_router = "default"
    name = "redist_profile"
    priority = 2
    action = "redist"
    types = ["connect"]
    interfaces = ["ethernet1/2"]
}

resource "panos_panorama_bgp_redist_rule" "export-aws" {
    template = var.panorama_template
    virtual_router = "default"
    name = panos_panorama_redistribution_profile_ipv4.redist_profile.name
}